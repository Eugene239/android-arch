name: Publish to Maven Central

# Usage:
# - For all modules: Run workflow without selecting module (or select empty option)
# - For single module: Select module from dropdown:
#   * onboarding-domain
#   * onboarding-data
#   * userstate-domain
#   * userstate-data

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to publish (leave empty for all modules)'
        required: false
        type: choice
        options:
          - ''
          - onboarding-domain
          - onboarding-data
          - userstate-domain
          - userstate-data
        default: ''

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up GPG
      uses: crazy-max/ghaction-import-gpg@v6
      continue-on-error: true
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        fingerprint: ${{ secrets.GPG_FINGERPRINT }}
        git_config_global: false
        
    - name: Configure GPG for CI
      run: |
        # Configure GPG to work in CI environment
        mkdir -p ~/.gnupg
        chmod 700 ~/.gnupg
        # Use no-use-agent to avoid gpg-agent issues in CI
        echo "no-use-agent" > ~/.gnupg/gpg.conf
        echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
        export GPG_TTY=$(tty)
        # Verify GPG key is available
        gpg --list-secret-keys --keyid-format LONG
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Determine publish tasks
      id: publish_tasks
      run: |
        if [ -z "${{ inputs.module }}" ]; then
          echo "Tasks will publish all modules" >> $GITHUB_STEP_SUMMARY
          echo "modules=all" >> $GITHUB_OUTPUT
        else
          echo "Task will publish module: ${{ inputs.module }}" >> $GITHUB_STEP_SUMMARY
          echo "modules=${{ inputs.module }}" >> $GITHUB_OUTPUT
          # Map artifact names to Gradle project paths (use project names from settings.gradle.kts)
          # Note: Gradle uses project.name for task paths, not include paths
          case "${{ inputs.module }}" in
            onboarding-domain)
              echo "gradle_path=:onboarding:onboarding-domain" >> $GITHUB_OUTPUT
              ;;
            onboarding-data)
              echo "gradle_path=:onboarding:onboarding-data" >> $GITHUB_OUTPUT
              ;;
            userstate-domain)
              echo "gradle_path=:userState:userstate-domain" >> $GITHUB_OUTPUT
              ;;
            userstate-data)
              echo "gradle_path=:userState:userstate-data" >> $GITHUB_OUTPUT
              ;;
          esac
        fi
        
    - name: Extract GPG Key ID
      id: gpg_keyid
      run: |
        # Get last 8 characters of fingerprint for signing.keyId
        FINGERPRINT="${{ secrets.GPG_FINGERPRINT }}"
        # Remove any spaces from fingerprint
        FINGERPRINT=$(echo "$FINGERPRINT" | tr -d ' ')
        KEY_ID="${FINGERPRINT: -8}"
        echo "keyId=$KEY_ID" >> $GITHUB_OUTPUT
        
    - name: Publish all modules to Maven Central
      if: steps.publish_tasks.outputs.modules == 'all'
      env:
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
        ORG_GRADLE_PROJECT_signingKeyId: ${{ steps.gpg_keyid.outputs.keyId }}
        ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
        ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        # Verify credentials are being passed (without showing values)
        echo "Checking credentials setup..."
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "ERROR: SONATYPE_USERNAME is not set"
          exit 1
        fi
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralPassword" ]; then
          echo "ERROR: SONATYPE_PASSWORD is not set"
          exit 1
        fi
        echo "mavenCentralUsername is set (length: ${#ORG_GRADLE_PROJECT_mavenCentralUsername})"
        echo "mavenCentralPassword is set (length: ${#ORG_GRADLE_PROJECT_mavenCentralPassword})"
        echo "INFO: For Central Portal User Token (from https://central.sonatype.com/usertoken):"
        echo "INFO: - Username should be the TOKEN NAME (not your login username!)"
        echo "INFO: - Password should be the TOKEN VALUE (passcode)"
        # vanniktech plugin task for publishing all modules (with automatic release)
        ./gradlew publishToMavenCentral --no-daemon
      
    - name: Publish single module to Maven Central
      if: steps.publish_tasks.outputs.modules != 'all'
      env:
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
        ORG_GRADLE_PROJECT_signingKeyId: ${{ steps.gpg_keyid.outputs.keyId }}
        ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PRIVATE_KEY }}
        ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        # Verify credentials are being passed (without showing values)
        echo "Checking credentials setup..."
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralUsername" ]; then
          echo "ERROR: SONATYPE_USERNAME is not set"
          exit 1
        fi
        if [ -z "$ORG_GRADLE_PROJECT_mavenCentralPassword" ]; then
          echo "ERROR: SONATYPE_PASSWORD is not set"
          exit 1
        fi
        echo "mavenCentralUsername is set (length: ${#ORG_GRADLE_PROJECT_mavenCentralUsername})"
        echo "mavenCentralPassword is set (length: ${#ORG_GRADLE_PROJECT_mavenCentralPassword})"
        echo "INFO: For Central Portal User Token (from https://central.sonatype.com/usertoken):"
        echo "INFO: - Username should be the TOKEN NAME (not your login username!)"
        echo "INFO: - Password should be the TOKEN VALUE (passcode)"
        # Publish single module using vanniktech plugin (with automatic release)
        ./gradlew ${{ steps.publish_tasks.outputs.gradle_path }}:publishToMavenCentral --no-daemon
      
    - name: Determine version
      id: version
      run: |
        if [ -n "${{ github.event.release.tag_name }}" ]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        elif [ -n "${{ github.ref_name }}" ]; then
          # Fallback to ref name (branch or tag) if release tag is not available
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        else
          # Final fallback - version from build.gradle.kts
          echo "version=1.0.0" >> $GITHUB_OUTPUT
        fi
        
    - name: Build summary
      if: success()
      run: |
        echo "## âœ… Published to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.publish_tasks.outputs.modules }}" == "all" ]; then
          echo "**Published all modules:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.eugene239.androidarch:onboarding-domain:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.eugene239.androidarch:onboarding-data:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.eugene239.androidarch:userstate-domain:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`io.github.eugene239.androidarch:userstate-data:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Published module:** \`io.github.eugene239.androidarch:${{ inputs.module }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Group:** \`io.github.eugene239.androidarch\`" >> $GITHUB_STEP_SUMMARY
        echo "**View on Maven Central:** https://central.sonatype.com/artifact/io.github.eugene239.androidarch" >> $GITHUB_STEP_SUMMARY

